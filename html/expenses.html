<!DOCTYPE html>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/unentered_table.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/table_helper.js"></script>
    <script>
    $( function() {
        $( "#datepicker" ).datepicker();
    } );
    </script>
    <script type="text/javascript">
    
        var pie_chart = function(txn_list) {
            var plot_div = document.createElement('div');
            plot_div.id = 'plot_div';
            document.body.appendChild(plot_div);
        
            data = [];
            pie_graph = {};
            
            labels = ["Essential", "Food", "Fun"];
            values = [0, 0, 0];

            // Loop through txns and pie chart main expense types.
            for (txn in txn_list) {
                txn_type = txn_list[txn].txn_type;
                amt = txn_list[txn].amount;

                // Match txn_type to label.
                label_index = labels.indexOf(txn_type);
                if (label_index != -1) {
                    values[label_index] += parseFloat(amt) * -1;
                }
            }
            
            pie_graph['values'] = values;
            pie_graph['labels'] = labels;
            pie_graph['type'] = 'pie';
            data.push(pie_graph);
            
            var layout = {
                title: 'Expenses By Type',
                height: 400,
                width: 500,
            };
            
            Plotly.newPlot('plot_div', data, layout);
        }
        
        var stacked_bar = function(txn_list) {
            var bar_div = document.createElement('div');
            bar_div.id = 'bar_div';
            document.body.appendChild(bar_div);
            
            labels = ["Income", "Essential", "Food", "Fun"];
            values = [0, 0, 0, 0];
            
            for (txn in txn_list) {
                txn_type = txn_list[txn].txn_type;
                amt = txn_list[txn].amount;
                
                // Match txn_type to label.
                label_index = labels.indexOf(txn_type);
                if (label_index != -1) {
                    if (label_index == 0) {
                        console.log('income' + Math.abs(parseFloat(amt)));
                    }
                    values[label_index] += Math.abs(parseFloat(amt));
                }
            }
            
            var income = {
                x: ['Income'],
                y: [values[0]],
                name: 'Income',
                type: 'bar'
            };
                
            var essentials = {
                x: ['Expenses'],
                y: [values[1]],
                
                name: 'Essentials',
                type: 'bar'
            };
            
            var food = {
                x: ['Expenses'],
                y: [values[2]],
                name: 'Food',
                type: 'bar'
            };
            
            var fun = {
                x: ['Expenses'],
                y: [values[3]],
                name: 'Fun',
                type: 'bar'
            };

            var data = [income, essentials, food, fun];
            // var data = [income];

            var layout = {
                title: 'Income vs. Expenses',
                barmode: 'stack',
            };

            Plotly.newPlot('bar_div', data, layout);
        }
        
        var date_picker = function() {
            var start_date = document.createElement('input');
            start_date.id = 'datepicker';
            document.body.appendChild(start_date);
        }

        window.onload = function() {
            var json_txn_list = {{db_txns|safe}};
            var length = {{length|safe}};
            var txn_list = json_txn_list.txns;

            date_picker();
            pie_chart(txn_list);
            stacked_bar(txn_list);
            document.body.appendChild(create_txn_table(txn_list));
        }
    </script>
</head>
</html>