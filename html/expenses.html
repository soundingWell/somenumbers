<!DOCTYPE html>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/header.css">
    <link rel="stylesheet" type="text/css" href="css/plot.css">
    <link rel="stylesheet" type="text/css" href="css/unentered_table.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/table_helper.js"></script>
</head>
<body>
    <div id="page_header">
    <button type="button" id="balance_btn" class="header_button">Balance</button>
    <button type="button" id="adj_exp_btn" class="header_button">Adjust Expenses</button>
    <button type="button" id="view_btn" class="header_button">View Expenses</button>
    <button type="button" id="clear_btn" class="header_button">Clear Expenses</button>
    </div>
    <script src="js/header.js"></script>
    <p></p>
    <p>Start Date: <input type="text" id="start_date"> End Date: <input type="text" id="end_date">
    <button type="button" id="recalculate" class="recalculate"> Recalculate</button>
    </p>
    <div id="expense_breakdown_div"></div>
    <script type="text/javascript">
    
        $( function() {
            $( "#start_date").datepicker();
        });
        $( function() {
            $( "#end_date").datepicker();
        });
    
        $( "#recalculate" ).click(function() {
            var start_date = $("#start_date").val();
            var end_date = $("#end_date").val();
            if (start_date == "" && end_date == "") {
                return;
            } else {
                if (start_date == "") {
                    start_date = 0;
                } else {
                    start_date = parseInt(translate_date(start_date));
                }
                if (end_date == "") {
                    end_date = 0;
                } else {
                    end_date = parseInt(translate_date(end_date));
                }
                $("#expense_breakdown_div").slideUp();
                expense_breakdown(start_date=start_date, end_date=end_date);
                $("#expense_breakdown_div").slideDown();
            }
        });
        
        // 11/23/2016 ->20161123
        var translate_date = function(date) {
            var month = date.slice(0, 2);
            var day = date.slice(3, 5);
            var year = date.slice(6, 10);
            return year + month + day;
        }
    
        var expense_breakdown = function(start_date=0, end_date=0) {
            var exp_div = document.getElementById("expense_breakdown_div");
            
            while (exp_div.firstChild) {
                exp_div.removeChild(exp_div.firstChild);
            }  
            
            var json_txn_list = {{db_txns|safe}};
            var txn_list = json_txn_list.txns;
        
            data = [];
            pie_graph = {};
            
            labels = ["Essential", "Food", "Fun"];
            values = [0, 0, 0];

            // Loop through txns and pie chart main expense types.
            for (txn in txn_list) {
                txn_date = txn_list[txn].date;

                if (start_date != 0) {
                    if (txn_date < start_date) {
                        continue;
                    }
                }
                
                if (end_date != 0) {
                    if (txn_date > end_date) {
                        break;
                    }
                }
                
                txn_type = txn_list[txn].txn_type;
                amt = txn_list[txn].amount;

                // Match txn_type to label.
                label_index = labels.indexOf(txn_type);
                if (label_index != -1) {
                    values[label_index] += parseFloat(amt) * -1;
                }
            }
            
            pie_graph['values'] = values;
            pie_graph['labels'] = labels;
            pie_graph['type'] = 'pie';
            data.push(pie_graph);
            
            var layout = {
                title: 'Expenses By Type',
                height: 400,
                width: 500,
            };
            
            Plotly.newPlot('expense_breakdown_div', data, layout);
        }
        
        var income_vs_expenses = function(txn_list) {         
            var bar_div = document.createElement('div');
            bar_div.id = 'bar_div';
            document.body.appendChild(bar_div);
            
            labels = ["Income", "Essential", "Food", "Fun"];
            values = [0, 0, 0, 0];
            
            for (txn in txn_list) {
                txn_date = txn_list[txn].date;
                /*
                if (txn_date < start_date) {
                    continue;
                }
                if (txn_date > end_date) {
                    break;
                }*/
                
                txn_type = txn_list[txn].txn_type;
                amt = txn_list[txn].amount;
                
                // Match txn_type to label.
                label_index = labels.indexOf(txn_type);
                if (label_index != -1) {
                    if (label_index == 0) {
                        console.log('income' + Math.abs(parseFloat(amt)));
                    }
                    values[label_index] += Math.abs(parseFloat(amt));
                }
            }
            
            var income = {
                x: ['Income'],
                y: [values[0]],
                name: 'Income',
                type: 'bar'
            };
                
            var essentials = {
                x: ['Expenses'],
                y: [values[1]],
                
                name: 'Essentials',
                type: 'bar'
            };
            
            var food = {
                x: ['Expenses'],
                y: [values[2]],
                name: 'Food',
                type: 'bar'
            };
            
            var fun = {
                x: ['Expenses'],
                y: [values[3]],
                name: 'Fun',
                type: 'bar'
            };

            var data = [income, essentials, food, fun];
            // var data = [income];

            var layout = {
                title: 'Income vs. Expenses',
                barmode: 'stack',
            };

            Plotly.newPlot('bar_div', data, layout);
        }
        
        var date_picker = function() {
            var start_date = document.createElement('input');
            start_date.id = 'datepicker';
            document.body.appendChild(start_date);
        }
        

        window.onload = function() {
            // income_vs_expenses(txn_list);
            expense_breakdown();
            var json_txn_list = {{db_txns|safe}};
            var txn_list = json_txn_list.txns;
            document.body.appendChild(create_txn_table(txn_list));
        }
    </script>
</body>
</html>